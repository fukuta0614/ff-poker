# マイルストーンB（安定化） 要件定義書

## 概要

マイルストーンAで実装した基本ゲームフローを安定化させ、実用的なゲームにする。再接続機能、タイムアウト処理、エラーハンドリング、ロギング機能を実装する。

**重要な設計方針**: 開発中は完全RAM管理とし、Redis等のROM永続化は行わない。仕様変更が頻繁な開発フェーズでは、データマイグレーションの負担を避ける。

## 関連文書

- **ユーザーストーリー**: [📖 milestone-b-user-stories.md](milestone-b-user-stories.md)
- **受け入れ基準**: [✅ milestone-b-acceptance-criteria.md](milestone-b-acceptance-criteria.md)

## 機能要件（EARS記法）

**【信頼性レベル凡例】**:
- 🔵 **青信号**: EARS要件定義書・設計文書・ユーザーヒアリングを参考にした確実な要件
- 🟡 **黄信号**: EARS要件定義書・設計文書・ユーザーヒアリングから妥当な推測による要件
- 🔴 **赤信号**: EARS要件定義書・設計文書・ユーザーヒアリングにない推測による要件

---

## 1. セッション管理機能

### 通常要件

- **REQ-001**: システムはプレイヤーが接続時に一意のplayerIdを生成しなければならない 🔵 *implementation-plan.md セクション「再接続機能実装」より*
- **REQ-002**: システムはplayerIdとsocketIdのマッピングをRAM上で管理しなければならない 🔵 *ユーザーヒアリング2025-11-22「完全RAM管理」より*
- **REQ-003**: システムはプレイヤーの最終接続時刻（lastSeen）を記録しなければならない 🔵 *requirements.md データモデル仕様より*
- **REQ-004**: システムは定期的に期限切れセッションを削除しなければならない 🟡 *セッションTTL実装の妥当な推測*

### 条件付き要件

- **REQ-101**: プレイヤーが接続した場合、システムは新規セッションを作成しなければならない 🔵 *architecture.md セッション管理設計より*
- **REQ-102**: プレイヤーが切断した場合、システムはセッションを保持し最終接続時刻を更新しなければならない 🔵 *implementation-plan.md「グレースピリオド設定」より*
- **REQ-103**: セッションが120秒以上非アクティブな場合、システムはそのセッションを削除しなければならない 🔵 *ユーザーヒアリング2025-11-22「120秒グレースピリオド」より*

### 制約要件

- **REQ-401**: システムはセッションデータをRAMのみで管理し、ディスク永続化を行ってはならない 🔵 *ユーザーヒアリング2025-11-22「Redis不使用、ROM保存なし」より*
- **REQ-402**: システムはRedisや外部データストアを使用してはならない 🔵 *ユーザーヒアリング2025-11-22「完全RAM管理」より*

---

## 2. 再接続機能

### 通常要件

- **REQ-005**: システムは切断されたプレイヤーの再接続を検知しなければならない 🔵 *implementation-plan.md「再接続機能実装」より*
- **REQ-006**: システムは再接続時にplayerIdを使用してプレイヤーを識別しなければならない 🔵 *requirements.md API仕様「reconnectRequest」より*
- **REQ-007**: システムは再接続成功時にゲーム状態を再送信しなければならない 🔵 *architecture.md「再接続フロー」より*

### 条件付き要件

- **REQ-104**: プレイヤーが120秒以内に再接続した場合、システムはゲームを継続しなければならない 🔵 *ユーザーヒアリング2025-11-22「120秒グレースピリオド」より*
- **REQ-105**: プレイヤーが120秒を超えて再接続できなかった場合、システムはそのプレイヤーを自動的にフォールドさせなければならない 🔵 *implementation-plan.md + ユーザーヒアリング2025-11-22より*
- **REQ-106**: プレイヤーが切断中の場合、システムは他のプレイヤーに「プレイヤーXが再接続を試みています... 残りN秒」と表示しなければならない 🔵 *ユーザーヒアリング2025-11-22「タイマー表示あり」より*

### 状態要件

- **REQ-201**: プレイヤーが切断状態にある場合、システムはそのプレイヤーのターンをスキップしてはならない 🔵 *implementation-plan.md「グレースピリオド設定」より*
- **REQ-202**: プレイヤーが再接続中の場合、システムはタイマーをカウントダウン表示しなければならない 🔵 *ユーザーヒアリング2025-11-22「タイマー表示」より*

---

## 3. タイムアウト処理機能

### 通常要件

- **REQ-008**: システムはプレイヤーのターン開始時に60秒のタイマーを開始しなければならない 🔵 *ユーザーヒアリング2025-11-22「60秒タイムアウト」より*
- **REQ-009**: システムはタイマーの残り時間をすべてのプレイヤーに表示しなければならない 🔵 *implementation-plan.md「カウントダウンタイマー表示」より*
- **REQ-010**: システムは残り10秒になった場合、視覚的警告を表示しなければならない 🔵 *ユーザーヒアリング2025-11-22「警告あり、残り10秒」より*

### 条件付き要件

- **REQ-107**: プレイヤーが60秒以内にアクションを実行しなかった場合、システムは自動的にアクションを決定しなければならない 🔵 *implementation-plan.md「タイムアウト時の自動処理」より*
- **REQ-108**: チェック可能な状況でタイムアウトした場合、システムは自動的にチェックしなければならない 🔵 *architecture.md「タイムアウト処理」より*
- **REQ-109**: チェック不可能な状況でタイムアウトした場合、システムは自動的にフォールドしなければならない 🔵 *architecture.md「タイムアウト処理」より*

### 状態要件

- **REQ-203**: タイマーがカウントダウン中の場合、システムは残り時間を1秒毎に更新しなければならない 🟡 *タイマーUI実装の妥当な推測*
- **REQ-204**: 残り時間が10秒以下の場合、システムはタイマー表示を警告色（赤色等）に変更しなければならない 🔵 *ユーザーヒアリング2025-11-22「視覚的警告」より*

---

## 4. エラーハンドリング機能

### 通常要件

- **REQ-011**: システムはすべてのプレイヤーアクションをサーバー側でバリデーションしなければならない 🔵 *architecture.md「サーバサイド検証」より*
- **REQ-012**: システムは不正なアクションを検知した場合、エラーメッセージをクライアントに送信しなければならない 🔵 *requirements.md API仕様「error」イベントより*
- **REQ-013**: システムはエラーメッセージに明確なエラー内容とエラーコードを含めなければならない 🔵 *implementation-plan.md「エラーメッセージの詳細化」より*

### 条件付き要件

- **REQ-110**: プレイヤーのターンでない時にアクションを実行した場合、システムは「NOT_YOUR_TURN」エラーを返さなければならない 🔵 *architecture.md「アクションバリデーション」より*
- **REQ-111**: 許可されていないアクションを実行した場合、システムは「INVALID_ACTION」エラーを返さなければならない 🔵 *architecture.md「アクションバリデーション」より*
- **REQ-112**: 不正なベット額を指定した場合、システムは「INVALID_BET_AMOUNT」エラーを返さなければならない 🔵 *architecture.md「アクションバリデーション」より*
- **REQ-113**: 存在しないルームに参加しようとした場合、システムは「ROOM_NOT_FOUND」エラーを返さなければならない 🔵 *socketHandler.ts 実装より*

---

## 5. ロギング機能

### 通常要件

- **REQ-014**: システムはwinstonライブラリを使用してログ出力しなければならない 🔵 *tech-stack.md「winston 3.x」より*
- **REQ-015**: システムはログレベル（ERROR, WARN, INFO, DEBUG）を使い分けなければならない 🔵 *architecture.md「ログレベル」より*
- **REQ-016**: システムはログを標準出力とファイルの両方に出力しなければならない 🟡 *winston標準構成からの妥当な推測*

### 条件付き要件

- **REQ-114**: エラーが発生した場合、システムはERRORレベルでスタックトレースを含めてログ出力しなければならない 🔵 *ユーザーヒアリング2025-11-22「デバッグ含む」より*
- **REQ-115**: ゲーム開始/終了時、システムはINFOレベルでログ出力しなければならない 🔵 *architecture.md「監視・ロギング」より*
- **REQ-116**: プレイヤーアクション実行時、システムはDEBUGレベルでアクション詳細をログ出力しなければならない 🔵 *ユーザーヒアリング2025-11-22「デバッグ含む」より*
- **REQ-117**: 開発環境の場合、システムはDEBUGレベルのログを出力しなければならない 🔵 *ユーザーヒアリング2025-11-22「開発時フル」より*
- **REQ-118**: 本番環境の場合、システムはINFOレベル以上のログのみ出力しなければならない 🟡 *本番環境ログ設定の妥当な推測*

### ログ記録内容要件

- **REQ-119**: システムはゲーム開始時にルームID、プレイヤー一覧、ブラインド額をログ出力しなければならない 🔵 *ユーザーヒアリング2025-11-22「詳細ログ」より*
- **REQ-120**: システムはカード配布時にデッキハッシュ値（監査用）をログ出力しなければならない 🔵 *implementation-plan.md「デッキシャッフル監査」より*
- **REQ-121**: システムはプレイヤーアクション時にplayerId、アクション種別、ベット額、残チップ数をログ出力しなければならない 🔵 *ユーザーヒアリング2025-11-22「詳細ログ」より*
- **REQ-122**: システムはポット計算時にメインポット額、サイドポット詳細をログ出力しなければならない 🔵 *ユーザーヒアリング2025-11-22「詳細ログ」より*
- **REQ-123**: システムは接続/切断イベント時にsocketId、playerId、タイムスタンプをログ出力しなければならない 🔵 *ユーザーヒアリング2025-11-22「詳細ログ」より*

---

## 6. クライアント側機能

### 再接続UI

- **REQ-024**: クライアントはplayerIdをlocalStorageに保存しなければならない 🔵 *implementation-plan.md「playerIdのローカルストレージ保存」より*
- **REQ-025**: クライアントは切断を検知した場合、再接続モーダルを表示しなければならない 🔵 *implementation-plan.md「再接続UIモーダル」より*
- **REQ-026**: クライアントは自動再接続を試行しなければならない 🔵 *implementation-plan.md「自動再接続処理」より*

### タイマーUI

- **REQ-027**: クライアントはターンタイマーをカウントダウン表示しなければならない 🔵 *implementation-plan.md「カウントダウンタイマー表示」より*
- **REQ-028**: クライアントは残り10秒でタイマー表示を警告色に変更しなければならない 🔵 *ユーザーヒアリング2025-11-22「視覚的警告」より*

### エラー表示UI

- **REQ-029**: クライアントはエラーメッセージをトースト通知で表示しなければならない 🔵 *implementation-plan.md「トースト通知」より*
- **REQ-030**: クライアントはエラー内容を分かりやすい日本語で表示しなければならない 🟡 *UX要件からの妥当な推測*

---

## 非機能要件

### パフォーマンス

- **NFR-001**: システムはアクション実行から結果反映まで1秒以内で処理しなければならない 🔵 *requirements.md「パフォーマンス」より*
- **NFR-002**: システムはタイマー更新を1秒間隔で正確に実行しなければならない 🟡 *タイマー機能実装からの妥当な推測*

### 可用性

- **NFR-101**: システムは切断後120秒以内の再接続を保証しなければならない 🔵 *ユーザーヒアリング2025-11-22より*
- **NFR-102**: システムは再接続時にゲーム状態を正しく復元しなければならない 🔵 *implementation-plan.md より*

### セキュリティ

- **NFR-201**: システムはすべてのアクションをサーバー側で検証しなければならない 🔵 *architecture.md「セキュリティ・チート対策」より*
- **NFR-202**: システムはクライアントからの入力を信頼してはならない 🔵 *architecture.md「サーバが唯一の真実」より*

### ユーザビリティ

- **NFR-301**: システムは接続状態を視覚的に表示しなければならない 🔵 *requirements.md「ユーザビリティ」より*
- **NFR-302**: システムはタイムアウト残り時間を常に表示しなければならない 🔵 *requirements.md「ユーザビリティ」より*
- **NFR-303**: システムはエラーメッセージを理解しやすい表現で表示しなければならない 🟡 *UX要件からの妥当な推測*

### メンテナンス性

- **NFR-401**: システムはログにより監査証跡を確保しなければならない 🔵 *requirements.md「メンテナンス性」より*
- **NFR-402**: システムはデバッグ情報を開発環境で出力しなければならない 🔵 *ユーザーヒアリング2025-11-22より*

---

## Edgeケース

### エラー処理

- **EDGE-001**: サーバー再起動時、すべてのゲームセッションは消失し、プレイヤーは新規にルームを作成する必要がある 🔵 *ユーザーヒアリング2025-11-22「RAM管理、ROM保存なし」より*
- **EDGE-002**: 複数のプレイヤーが同時に切断した場合、システムはそれぞれ独立してグレースピリオドを管理しなければならない 🟡 *再接続設計からの妥当な推測*
- **EDGE-003**: グレースピリオド中にゲームが終了した場合、システムは切断プレイヤーをフォールド扱いで処理しなければならない 🟡 *ゲームフロー設計からの妥当な推測*

### 境界値

- **EDGE-101**: タイムアウト時間がちょうど0秒になった瞬間、システムは即座に自動アクションを実行しなければならない 🟡 *タイマー実装からの妥当な推測*
- **EDGE-102**: グレースピリオドがちょうど120秒になった瞬間、システムはセッションを削除しなければならない 🔵 *ユーザーヒアリング2025-11-22より*

---

## 除外項目（マイルストーンBでは実装しない）

- **チャット機能**: マイルストーンBでは実装しない 🔵 *ユーザーヒアリング2025-11-22「不要」より*
- **Redis/外部データストア**: 開発中は使用しない 🔵 *ユーザーヒアリング2025-11-22「完全RAM管理」より*
- **PostgreSQL監査ログ**: マイルストーンBでは使用しない 🔵 *tech-stack.md「オプション」 + ユーザーヒアリング2025-11-22より*
- **複数サーバーインスタンス対応**: 単一サーバーのみ 🔵 *ユーザーヒアリング2025-11-22より*

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-22 | 1.0 | 初版作成（ユーザーヒアリング反映：完全RAM管理、Redis不使用、120秒グレースピリオド、60秒タイムアウト、詳細ログ、チャット機能除外） |
