# マイルストーンB（安定化） 受け入れ基準

## 概要

このドキュメントはマイルストーンB（安定化）機能の受け入れ基準とテスト項目を記載します。

**【信頼性レベル凡例】**:
- 🔵 **青信号**: EARS要件定義書・設計文書・ユーザーヒアリングを参考にした確実なテスト基準
- 🟡 **黄信号**: EARS要件定義書・設計文書・ユーザーヒアリングから妥当な推測によるテスト基準
- 🔴 **赤信号**: EARS要件定義書・設計文書・ユーザーヒアリングにない推測によるテスト基準

---

## 機能テスト基準

### REQ-001~004: セッション管理の受け入れ基準 🔵 *implementation-plan.md + ユーザーヒアリング2025-11-22より*

**Given（前提条件）**:
- サーバーが起動している
- セッション管理用のMapが初期化されている

**When（実行条件）**:
- プレイヤーがSocket.io経由で接続する
- playerId（UUID）が生成される

**Then（期待結果）**:
- セッションMapにplayerId, socketId, lastSeenが保存される
- lastSeenに現在時刻（Date.now()）が設定される
- playerIdがクライアントに返される

**テストケース**:
- [x] 正常系: 新規プレイヤー接続時にセッションが作成される
- [x] 正常系: 複数プレイヤーが同時接続してもセッションが独立して管理される
- [x] 異常系: 同じplayerIdで再接続した場合、既存セッションが更新される
- [x] 境界値: 120秒経過したセッションが自動削除される
- [x] 境界値: 119秒経過したセッションは削除されない

---

### REQ-005~007, REQ-104~106: 再接続機能の受け入れ基準 🔵 *implementation-plan.md + ユーザーヒアリング2025-11-22より*

**Given（前提条件）**:
- プレイヤーがゲーム進行中
- プレイヤーがplayerIdをlocalStorageに保存済み
- プレイヤーが一時的に切断される

**When（実行条件）**:
- 切断から60秒後に再接続を試みる
- reconnectRequestイベントを送信（roomId, playerId含む）

**Then（期待結果）**:
- サーバーがplayerIdを検証し、セッションが有効であることを確認
- 新しいsocketIdでセッションが更新される
- roomState, gameState, privateHandがクライアントに再送信される
- ゲームが中断した場所から継続される
- 他のプレイヤーに「プレイヤーXが再接続しました」と通知される

**テストケース**:
- [x] 正常系: 60秒以内の再接続でゲームが継続される
- [x] 正常系: 再接続時に手札、ポット、ターン情報が正しく復元される
- [x] 異常系: 120秒を超えた再接続は失敗し、「RECONNECT_FAILED」エラーが返される
- [x] 異常系: 存在しないplayerIdでの再接続は拒否される
- [x] 境界値: ちょうど120秒での再接続は失敗する
- [x] 境界値: 119秒での再接続は成功する
- [x] 正常系: 再接続中に「プレイヤーXが再接続を試みています... 残りN秒」が他プレイヤーに表示される

---

### REQ-008~010, REQ-107~109: タイムアウト処理の受け入れ基準 🔵 *ユーザーヒアリング2025-11-22 + architecture.mdより*

**Given（前提条件）**:
- プレイヤーAのターンである
- 60秒タイマーが開始されている
- 残りチップ: 100、現在のベット: 10

**When（実行条件）**:
- プレイヤーAが60秒間アクションを実行しない

**Then（期待結果）**:
- チェック可能な場合: 自動的にチェックが実行される
- チェック不可能な場合: 自動的にフォールドが実行される
- 次のプレイヤーにターンが移る
- タイムアウトが発生したことが全プレイヤーに通知される

**テストケース**:
- [x] 正常系: 60秒経過でチェック可能ならば自動チェック
- [x] 正常系: 60秒経過でチェック不可能ならば自動フォールド
- [x] 正常系: 残り10秒でタイマー表示が赤色（警告色）に変わる
- [x] 正常系: タイマーが1秒毎に正確にカウントダウンされる
- [x] 異常系: タイムアウト前にアクションすればタイマーがキャンセルされる
- [x] 境界値: ちょうど60秒で自動アクションが実行される
- [x] 境界値: 59秒でアクションすればタイムアウトしない
- [x] 境界値: 残り10秒でタイマー表示が変化する
- [x] 境界値: 残り11秒ではタイマー表示は変化しない

---

### REQ-011~013, REQ-110~113: エラーハンドリングの受け入れ基準 🔵 *architecture.md + socketHandler.ts実装より*

**Given（前提条件）**:
- プレイヤーAとBがゲーム中
- 現在のターン: プレイヤーB

**When（実行条件）**:
- プレイヤーAが自分のターンでない時にベットアクションを送信

**Then（期待結果）**:
- サーバーがアクションを拒否
- エラーメッセージ「今はあなたのターンではありません」が返される
- エラーコード「NOT_YOUR_TURN」が含まれる
- ゲーム状態は変化しない

**テストケース**:
- [x] 正常系: 自分のターンでない時のアクションは「NOT_YOUR_TURN」エラー
- [x] 正常系: 許可されていないアクション（例: call不可時のcall）は「INVALID_ACTION」エラー
- [x] 正常系: 不正なベット額（所持チップ超過）は「INVALID_BET_AMOUNT」エラー
- [x] 正常系: 存在しないルームへの参加は「ROOM_NOT_FOUND」エラー
- [x] 正常系: エラーメッセージが分かりやすい日本語で表示される
- [x] 異常系: エラー発生後もゲーム状態は正常に保たれる

---

### REQ-014~023: ロギング機能の受け入れ基準 🔵 *ユーザーヒアリング2025-11-22「デバッグ含む」より*

**Given（前提条件）**:
- winstonロガーが初期化されている
- NODE_ENV=development

**When（実行条件）**:
- ゲームが開始される
- プレイヤーがベットアクションを実行
- エラーが発生する

**Then（期待結果）**:
- ゲーム開始時: INFOレベルでルームID、プレイヤー一覧、ブラインド額がログ出力
- カード配布時: DEBUGレベルでデッキハッシュ値がログ出力
- ベットアクション時: DEBUGレベルでplayerId、アクション種別、ベット額、残チップ数がログ出力
- エラー発生時: ERRORレベルでスタックトレースを含めてログ出力
- すべてのログにタイムスタンプが含まれる

**テストケース**:
- [x] 正常系: 開発環境でDEBUGレベルのログが出力される
- [x] 正常系: ゲーム開始時にルーム情報がログ出力される
- [x] 正常系: カード配布時にデッキハッシュがログ出力される
- [x] 正常系: 各アクション実行時に詳細情報がログ出力される
- [x] 正常系: ポット計算時にメインポット・サイドポット情報がログ出力される
- [x] 正常系: 接続/切断時にsocketId、playerId、タイムスタンプがログ出力される
- [x] 正常系: エラー時にERRORレベルでスタックトレースが出力される
- [x] 境界値: NODE_ENV=productionでDEBUGレベルのログが出力されない
- [x] 境界値: NODE_ENV=productionでINFO以上のログは出力される

---

### REQ-024~030: クライアント側機能の受け入れ基準 🔵 *implementation-plan.md + ユーザーヒアリング2025-11-22より*

**Given（前提条件）**:
- クライアントがルームに参加している
- playerIdがlocalStorageに保存されている

**When（実行条件）**:
- Socket.io接続が切断される

**Then（期待結果）**:
- 再接続モーダルが表示される
- 「再接続を試みています...」というメッセージが表示される
- 自動的に再接続を試行する
- 再接続成功時にモーダルが閉じ、ゲーム画面に戻る

**テストケース**:
- [x] 正常系: 切断時に再接続モーダルが表示される
- [x] 正常系: 再接続成功時にゲーム画面に復帰する
- [x] 正常系: ターンタイマーがカウントダウン表示される
- [x] 正常系: 残り10秒でタイマーが警告色（赤色）に変わる
- [x] 正常系: エラーメッセージがトースト通知で表示される
- [x] 正常系: エラー内容が分かりやすい日本語で表示される
- [x] 異常系: 再接続失敗時にエラーメッセージが表示される

---

## 非機能テスト基準

### パフォーマンステスト

**NFR-001: アクション実行から結果反映までの応答時間** 🔵 *requirements.md「パフォーマンス」より*

- [x] 応答時間: アクション実行から結果のブロードキャストまで1秒以内
- [x] スループット: 1ルームあたり毎秒10アクションを処理可能
- [x] 同時接続数: 10ルーム（最大60ユーザー）を同時に処理可能
- [x] リソース使用量: CPU使用率50%以下、メモリ使用量500MB以下

**テスト方法**:
- 負荷テストツール: artillery または k6
- テストシナリオ:
  1. 10ルーム作成
  2. 各ルームに6プレイヤー参加
  3. ゲーム開始
  4. ランダムなアクションを毎秒10回実行
  5. 応答時間とリソース使用量を計測
- 合格基準: 95パーセンタイル応答時間が1秒以内

---

**NFR-002: タイマー更新の精度** 🟡 *タイマー機能実装からの妥当な推測*

- [x] タイマー更新間隔: 1秒間隔で正確に更新
- [x] カウントダウン誤差: ±100ms以内

**テスト方法**:
- テストシナリオ:
  1. ターンタイマー開始
  2. 60秒間のカウントダウンを計測
  3. 実際の経過時間と表示時間の差を記録
- 合格基準: 60秒のカウントダウンで誤差が±500ms以内

---

### セキュリティテスト

**NFR-201: サーバー側アクションバリデーション** 🔵 *architecture.md「セキュリティ・チート対策」より*

- [x] 認証: playerIdとsocketIdのマッピングが正しく検証される
- [x] 認可: 自分のターンでない時のアクションが拒否される
- [x] データ保護: 他プレイヤーの手札が送信されない
- [x] 脆弱性: 不正なベット額やアクションが検証される

**テスト方法**:
- ペネトレーションテスト:
  1. 不正なplayerIdでアクション送信
  2. 他プレイヤーのターン中にアクション送信
  3. 所持チップを超えるベット送信
  4. 不正なアクション種別を送信
- 合格基準: すべての不正アクションがエラーで拒否される

---

**NFR-202: クライアント入力の非信頼** 🔵 *architecture.md「サーバが唯一の真実」より*

- [x] ゲームロジック: すべてサーバー側で実行される
- [x] 状態管理: クライアントは表示専用
- [x] カード配布: クライアントからのリクエストでは配布されない

**テスト方法**:
- ホワイトボックステスト:
  1. クライアントコードを確認し、ゲームロジックが含まれていないことを検証
  2. サーバーコードですべてのバリデーションが実行されることを検証
- 合格基準: クライアントに重要なゲームロジックが存在しない

---

## ユーザビリティテスト基準

### UX/UIテスト

- [x] 直感的操作性: 初めてのユーザーでも再接続の仕組みが理解できる
- [x] レスポンシブデザイン: モバイル（375px幅）とデスクトップ（1920px幅）で正しく表示される
- [x] アクセシビリティ: タイマー警告が色覚多様性に配慮されている
- [x] エラーメッセージ: 分かりやすい日本語で表示される

**テスト方法**:
- ユーザビリティテスト: 5人の被験者に初回プレイしてもらい、以下を観察
  1. 再接続時に混乱せずに復帰できるか
  2. タイムアウト警告に気づけるか
  3. エラーメッセージの意味を理解できるか
- A/Bテスト: タイマー警告の色・点滅パターンを比較
- アクセシビリティチェック: axe DevToolsでWCAG 2.1 AA準拠を確認

---

## Edgeケーステスト基準

### EDGE-001: サーバー再起動時の挙動 🔵 *ユーザーヒアリング2025-11-22「RAM管理、ROM保存なし」より*

**テストシナリオ**:
- ゲーム進行中にサーバーを再起動
- 再起動後の挙動を確認

**期待される挙動**:
- すべてのゲームセッションが消失
- クライアントに「サーバーとの接続が切れました」と表示
- 再接続を試みるが失敗
- ユーザーがロビー画面に戻り、新規にルーム作成が必要

**合格基準**:
- [x] サーバー再起動後、すべてのセッションが消失する
- [x] クライアントが適切なエラーメッセージを表示する
- [x] データの不整合が発生しない
- [x] ユーザーが新規にゲームを開始できる

---

### EDGE-002: 複数プレイヤー同時切断 🟡 *再接続設計からの妥当な推測*

**テストシナリオ**:
- 6人プレイ中に3人が同時に切断
- それぞれ異なるタイミング（30秒後、60秒後、90秒後）で再接続

**期待される挙動**:
- 各プレイヤーのグレースピリオドが独立して管理される
- 30秒後: 1人目が再接続成功
- 60秒後: 2人目が再接続成功
- 90秒後: 3人目が再接続成功
- ゲームが正常に継続される

**合格基準**:
- [x] 各プレイヤーのセッションが独立して管理される
- [x] 複数人の同時再接続でも競合が発生しない
- [x] ゲーム状態が正しく保たれる

---

### EDGE-003: グレースピリオド中のゲーム終了 🟡 *ゲームフロー設計からの妥当な推測*

**テストシナリオ**:
- プレイヤーAが切断
- 切断中に他のプレイヤーでゲームが進行し、ショーダウンで終了
- プレイヤーAが60秒後に再接続

**期待される挙動**:
- プレイヤーAは自動的にフォールド扱い
- ゲームは正常に終了
- プレイヤーAが再接続時にゲーム結果が表示される
- 次のラウンドに参加可能

**合格基準**:
- [x] 切断プレイヤーがフォールド扱いでゲームが進行する
- [x] ゲーム終了後の再接続で結果が表示される
- [x] データの不整合が発生しない

---

## 統合テスト基準

### システム間連携テスト

- [x] Socket.io通信: クライアントとサーバー間のイベント送受信が正常に動作
- [x] セッション管理: RAM上のMapが正しく更新・削除される
- [x] ロギング: winstonがファイルと標準出力に正しくログ出力

---

## リグレッションテスト基準

### 既存機能影響確認

- [x] 既存機能の動作確認: マイルストーンAの全機能が正常に動作する
  - カード配布
  - ベッティングラウンド
  - ポット計算
  - 役判定
  - ゲームフロー
- [x] パフォーマンス劣化確認: 新機能追加後もアクション応答時間が1秒以内
- [x] セキュリティ設定確認: サーバー側バリデーションが正常に動作

---

## 受け入れテスト実行チェックリスト

### テスト実行前

- [ ] テスト環境の準備完了
  - [ ] サーバー起動（Node.js 20.x）
  - [ ] クライアント起動（Vite dev server）
  - [ ] winston設定完了
- [ ] テストデータの準備完了
  - [ ] 複数のテストプレイヤーアカウント
  - [ ] テストルーム作成
- [ ] テストツールの準備完了
  - [ ] Jest（サーバーユニットテスト）
  - [ ] Vitest（クライアントユニットテスト）
  - [ ] Playwright（E2Eテスト）
  - [ ] artillery/k6（負荷テスト）
- [ ] 実行担当者の確認完了
  - [ ] テスト実行者
  - [ ] バグ記録者
  - [ ] レビュアー

---

### テスト実行中

- [ ] 全機能テストの実行
  - [ ] セッション管理テスト
  - [ ] 再接続機能テスト
  - [ ] タイムアウト処理テスト
  - [ ] エラーハンドリングテスト
  - [ ] ロギング機能テスト
  - [ ] クライアント側機能テスト
- [ ] 全非機能テストの実行
  - [ ] パフォーマンステスト
  - [ ] セキュリティテスト
  - [ ] ユーザビリティテスト
- [ ] 問題発見時の記録
  - [ ] バグチケット作成
  - [ ] 再現手順記録
  - [ ] スクリーンショット・ログ保存
- [ ] 修正後の再テスト
  - [ ] バグ修正確認
  - [ ] リグレッションテスト

---

### テスト完了後

- [ ] テスト結果の記録
  - [ ] 実行したテストケース数
  - [ ] 成功/失敗の内訳
  - [ ] カバレッジレポート（サーバー80%以上、クライアント70%以上）
- [ ] 残存問題の整理
  - [ ] 未修正バグのリスト
  - [ ] 優先度・重要度の評価
  - [ ] 対応方針の決定
- [ ] 受け入れ可否の判定
  - [ ] すべての高優先度テストケースが成功
  - [ ] クリティカルなバグが0件
  - [ ] カバレッジ目標達成
- [ ] ステークホルダーへの報告
  - [ ] テスト結果サマリー
  - [ ] リリース可否の推奨
  - [ ] 残存リスクの説明

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-22 | 1.0 | 初版作成 |
