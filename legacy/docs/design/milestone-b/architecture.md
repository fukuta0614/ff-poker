# ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³Bï¼ˆå®‰å®šåŒ–ï¼‰ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³Bã§ã¯ã€ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³Aã§å®Ÿè£…ã—ãŸåŸºæœ¬ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ã«ã€å†æ¥ç¶šæ©Ÿèƒ½ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€å®Ÿç”¨çš„ãªã‚²ãƒ¼ãƒ ã«ã™ã‚‹ã€‚

**è¨­è¨ˆã®é‡è¦ãªæ–¹é‡**:
- **å®Œå…¨RAMç®¡ç†**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’RAMã®ã¿ã§ç®¡ç†ã—ã€Redisç­‰ã®å¤–éƒ¨ã‚¹ãƒˆã‚¢ã¯ä½¿ç”¨ã—ãªã„
- **é–‹ç™ºä¸­ã®æŸ”è»Ÿæ€§**: ROMæ°¸ç¶šåŒ–ã‚’é¿ã‘ã€ä»•æ§˜å¤‰æ›´æ™‚ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è² æ‹…ã‚’å›é¿
- **ã‚µãƒ¼ãƒãƒ¼ãŒå”¯ä¸€ã®çœŸå®Ÿ**: ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œ

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³

### é¸æŠãƒ‘ã‚¿ãƒ¼ãƒ³: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼ãƒ¢ãƒ‡ãƒ« + ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**ç†ç”±**:
1. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§**: Socket.ioã«ã‚ˆã‚‹åŒæ–¹å‘é€šä¿¡ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ã‚’å®Ÿç¾
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ã‚µãƒ¼ãƒãƒ¼å´ã§å…¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è¡¨ç¤ºã®ã¿
3. **ã‚·ãƒ³ãƒ—ãƒ«**: ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ä¸è¦ã€å˜ä¸€ã‚µãƒ¼ãƒãƒ¼ã§ååˆ†
4. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: å°†æ¥çš„ã«Redis adapterã§æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«å¯èƒ½ï¼ˆç¾æ™‚ç‚¹ã§ã¯ä¸ä½¿ç”¨ï¼‰

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Client (React)             â”‚
â”‚  - UI Components                    â”‚
â”‚  - Socket.io Client                 â”‚
â”‚  - State Management (Context API)   â”‚
â”‚  - localStorage (playerIdä¿å­˜)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ WebSocket (Socket.io)
              â”‚ HTTPS/WSS
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node.js Game Server                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Socket.io Server                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Session Manager (RAM Map)       â”‚â”‚
â”‚  â”‚ - playerId â†’ session mapping    â”‚â”‚
â”‚  â”‚ - TTL: 120ç§’                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Turn Timer Manager              â”‚â”‚
â”‚  â”‚ - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ60ç§’ï¼‰        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Game Manager (æ—¢å­˜)             â”‚â”‚
â”‚  â”‚ - Roomç®¡ç†                      â”‚â”‚
â”‚  â”‚ - Roundç®¡ç†                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Logger Service (winston)        â”‚â”‚
â”‚  â”‚ - ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›                   â”‚â”‚
â”‚  â”‚ - æ¨™æº–å‡ºåŠ›                       â”‚â”‚
â”‚  â”‚ - DEBUG/INFO/WARN/ERROR         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- **UI**: React 18.x + TypeScript ğŸ”µ *tech-stack.md ã‚ˆã‚Š*
- **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: Vite 5.x ğŸ”µ *tech-stack.md ã‚ˆã‚Š*
- **çŠ¶æ…‹ç®¡ç†**: React Context API + useReducer ğŸ”µ *tech-stack.md ã‚ˆã‚Š*
- **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: Tailwind CSS 3.x ğŸ”µ *tech-stack.md ã‚ˆã‚Š*
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡**: socket.io-client 4.x ğŸ”µ *tech-stack.md ã‚ˆã‚Š*

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼ˆè¿½åŠ åˆ†ï¼‰

```
client/src/
  /components
    /common
      ReconnectModal.tsx       # å†æ¥ç¶šãƒ¢ãƒ¼ãƒ€ãƒ« ğŸ”µ *REQ-025ã‚ˆã‚Š*
      Timer.tsx                # ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼ ğŸ”µ *REQ-027ã‚ˆã‚Š*
      Toast.tsx                # ã‚¨ãƒ©ãƒ¼é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ ğŸ”µ *REQ-029ã‚ˆã‚Š*
  /hooks
    useReconnect.ts            # å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ ğŸ”µ *REQ-026ã‚ˆã‚Š*
    useTimer.ts                # ã‚¿ã‚¤ãƒãƒ¼ç®¡ç† ğŸŸ¡ *ã‚¿ã‚¤ãƒãƒ¼UIå®Ÿè£…ã®å¦¥å½“ãªæ¨æ¸¬*
  /services
    sessionStorage.ts          # playerIdç®¡ç† ğŸ”µ *REQ-024ã‚ˆã‚Š*
```

### çŠ¶æ…‹ç®¡ç†æˆ¦ç•¥ï¼ˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³Bè¿½åŠ ï¼‰

```typescript
// æ—¢å­˜ã®GameContextã«è¿½åŠ 
interface GameState {
  // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  room: Room | null;
  roundState: RoundState | null;
  myPlayerId: string | null;
  myHand: string[];

  // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³Bè¿½åŠ  ğŸ”µ *milestone-bè¦ä»¶ã‚ˆã‚Š*
  connectionStatus: 'connected' | 'disconnected' | 'reconnecting';
  reconnectTimer: number | null; // æ®‹ã‚Šç§’æ•°
  turnTimer: number | null; // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼æ®‹ã‚Šç§’æ•°
  error: ErrorMessage | null; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
}
```

---

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ **: Node.js 20.x (LTS) ğŸ”µ *tech-stack.md ã‚ˆã‚Š*
- **Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Express 4.x ğŸ”µ *tech-stack.md ã‚ˆã‚Š*
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡**: socket.io 4.x ğŸ”µ *tech-stack.md ã‚ˆã‚Š*
- **ãƒ­ã‚®ãƒ³ã‚°**: winston 3.x ğŸ”µ *tech-stack.md + REQ-014ã‚ˆã‚Š*
- **è¨€èª**: TypeScript 5.x ğŸ”µ *tech-stack.md ã‚ˆã‚Š*

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼ˆè¿½åŠ åˆ†ï¼‰

```
server/src/
  /services
    SessionManager.ts          # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† ğŸ”µ *REQ-001~004ã‚ˆã‚Š*
    TurnTimerManager.ts        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç† ğŸ”µ *REQ-008~010ã‚ˆã‚Š*
    LoggerService.ts           # ãƒ­ã‚®ãƒ³ã‚° ğŸ”µ *REQ-014~016ã‚ˆã‚Š*
  /utils
    validation.ts              # å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– ğŸ”µ *REQ-011ã‚ˆã‚Š*
```

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

#### 1. SessionManagerï¼ˆæ–°è¦ï¼‰ğŸ”µ *REQ-001~004, REQ-101~103ã‚ˆã‚Š*

**è²¬å‹™**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã€ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ”ãƒªã‚ªãƒ‰ç®¡ç†

```typescript
class SessionManager {
  private sessions: Map<string, PlayerSession>;
  private readonly GRACE_PERIOD = 120000; // 120ç§’ ğŸ”µ *ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ’ã‚¢ãƒªãƒ³ã‚°2025-11-22ã‚ˆã‚Š*

  createSession(playerId: string, socketId: string): void;
  updateSession(playerId: string, socketId: string): void;
  reconnect(playerId: string, newSocketId: string): boolean;
  cleanupExpiredSessions(): void; // å®šæœŸå®Ÿè¡Œ
  isSessionValid(playerId: string): boolean;
}

interface PlayerSession {
  playerId: string;
  socketId: string;
  lastSeen: number; // timestamp
}
```

**è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ**:
- RAMï¼ˆMapï¼‰ã®ã¿ã§ç®¡ç†ã€æ°¸ç¶šåŒ–ãªã— ğŸ”µ *REQ-401, REQ-402ã‚ˆã‚Š*
- 120ç§’ã®TTLï¼ˆTime To Liveï¼‰ ğŸ”µ *REQ-103ã‚ˆã‚Š*
- å®šæœŸçš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ï¼ˆsetIntervalï¼‰ ğŸŸ¡ *ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†å®Ÿè£…ã®å¦¥å½“ãªæ¨æ¸¬*

---

#### 2. TurnTimerManagerï¼ˆæ–°è¦ï¼‰ğŸ”µ *REQ-008~010, REQ-107~109ã‚ˆã‚Š*

**è²¬å‹™**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†ã€è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```typescript
class TurnTimerManager {
  private timers: Map<string, NodeJS.Timeout>;
  private readonly TIMEOUT_DURATION = 60000; // 60ç§’ ğŸ”µ *ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ’ã‚¢ãƒªãƒ³ã‚°2025-11-22ã‚ˆã‚Š*
  private readonly WARNING_THRESHOLD = 10000; // 10ç§’ ğŸ”µ *ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ’ã‚¢ãƒªãƒ³ã‚°2025-11-22ã‚ˆã‚Š*

  startTimer(roomId: string, playerId: string, onTimeout: () => void): void;
  cancelTimer(roomId: string): void;
  getRemainingTime(roomId: string): number;
}
```

**è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ**:
- NodeJS.Timeoutã‚’ä½¿ç”¨ã—ãŸã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®è‡ªå‹•å‡¦ç†
  - ãƒã‚§ãƒƒã‚¯å¯èƒ½: è‡ªå‹•ãƒã‚§ãƒƒã‚¯ ğŸ”µ *REQ-108ã‚ˆã‚Š*
  - ãƒã‚§ãƒƒã‚¯ä¸å¯: è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ ğŸ”µ *REQ-109ã‚ˆã‚Š*
- æ®‹ã‚Šæ™‚é–“ã‚’1ç§’æ¯ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ ğŸ”µ *REQ-203ã‚ˆã‚Š*

---

#### 3. LoggerServiceï¼ˆæ–°è¦ï¼‰ğŸ”µ *REQ-014~023ã‚ˆã‚Š*

**è²¬å‹™**: æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ç®¡ç†

```typescript
import winston from 'winston';

class LoggerService {
  private logger: winston.Logger;

  constructor() {
    this.logger = winston.createLogger({
      level: process.env.NODE_ENV === 'production' ? 'info' : 'debug', // ğŸ”µ *REQ-117, REQ-118ã‚ˆã‚Š*
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json()
      ),
      transports: [
        new winston.transports.Console(), // æ¨™æº–å‡ºåŠ›
        new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
        new winston.transports.File({ filename: 'logs/combined.log' })
      ]
    });
  }

  debug(message: string, meta?: object): void;
  info(message: string, meta?: object): void;
  warn(message: string, meta?: object): void;
  error(message: string, error?: Error, meta?: object): void;
}
```

**ãƒ­ã‚°å‡ºåŠ›å†…å®¹** ğŸ”µ *REQ-119~123ã‚ˆã‚Š*:
- ã‚²ãƒ¼ãƒ é–‹å§‹: ãƒ«ãƒ¼ãƒ IDã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã€ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰é¡
- ã‚«ãƒ¼ãƒ‰é…å¸ƒ: ãƒ‡ãƒƒã‚­ãƒãƒƒã‚·ãƒ¥å€¤ï¼ˆç›£æŸ»ç”¨ï¼‰
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ: playerIdã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥ã€ãƒ™ãƒƒãƒˆé¡ã€æ®‹ãƒãƒƒãƒ—æ•°
- ãƒãƒƒãƒˆè¨ˆç®—: ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆã€ã‚µã‚¤ãƒ‰ãƒãƒƒãƒˆè©³ç´°
- æ¥ç¶š/åˆ‡æ–­: socketIdã€playerIdã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
- ã‚¨ãƒ©ãƒ¼: ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹å«ã‚€

---

#### 4. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– ğŸ”µ *REQ-011~013, REQ-110~113ã‚ˆã‚Š*

**è²¬å‹™**: ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚µãƒ¼ãƒãƒ¼å´æ¤œè¨¼ã€è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

```typescript
// server/src/utils/validation.ts

export function validateAction(
  playerId: string,
  action: Action,
  gameState: GameState
): ValidationResult {
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‹ç¢ºèª
  if (gameState.currentPlayerId !== playerId) {
    return {
      valid: false,
      errorCode: 'NOT_YOUR_TURN',
      errorMessage: 'ä»Šã¯ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“' // ğŸ”µ *REQ-030ã‚ˆã‚Š*
    };
  }

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  const allowedActions = getAllowedActions(playerId, gameState);
  if (!allowedActions.includes(action.type)) {
    return {
      valid: false,
      errorCode: 'INVALID_ACTION',
      errorMessage: `${action.type}ã¯ç¾åœ¨å®Ÿè¡Œã§ãã¾ã›ã‚“`
    };
  }

  // ãƒ™ãƒƒãƒˆé¡ã®å¦¥å½“æ€§ç¢ºèª
  if ((action.type === 'bet' || action.type === 'raise') && action.amount) {
    if (action.amount > gameState.playerChips[playerId]) {
      return {
        valid: false,
        errorCode: 'INVALID_BET_AMOUNT',
        errorMessage: 'æ‰€æŒãƒãƒƒãƒ—ã‚’è¶…ãˆã‚‹ãƒ™ãƒƒãƒˆã¯ã§ãã¾ã›ã‚“'
      };
    }
  }

  return { valid: true };
}

interface ValidationResult {
  valid: boolean;
  errorCode?: string;
  errorMessage?: string;
}
```

---

## ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢è¨­è¨ˆ

### RAMç®¡ç†ã®ã¿ï¼ˆRedisä¸ä½¿ç”¨ï¼‰ğŸ”µ *REQ-401, REQ-402, ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ’ã‚¢ãƒªãƒ³ã‚°2025-11-22ã‚ˆã‚Š*

**ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ **:

```typescript
// SessionManagerå†…
private sessions: Map<playerId, PlayerSession>

// TurnTimerManagerå†…
private timers: Map<roomId, NodeJS.Timeout>

// GameManagerå†…ï¼ˆæ—¢å­˜ï¼‰
private rooms: Map<roomId, Room>
```

**ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–æ–¹é‡**:
- **ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•æ™‚**: å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ï¼ˆè¨±å®¹ï¼‰ ğŸ”µ *EDGE-001ã‚ˆã‚Š*
- **ãƒ¡ãƒ¢ãƒªç®¡ç†**: å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å®šæœŸå‰Šé™¤ã«ã‚ˆã‚Šãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ ğŸŸ¡ *RAMç®¡ç†è¨­è¨ˆã®å¦¥å½“ãªæ¨æ¸¬*

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 1. ã‚µãƒ¼ãƒãƒ¼å´æ¤œè¨¼ã®å¾¹åº• ğŸ”µ *NFR-201, NFR-202ã‚ˆã‚Š*

- ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’ä¿¡é ¼ã—ãªã„
- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚µãƒ¼ãƒãƒ¼å´ã®ã¿ã§å®Ÿè¡Œ

### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ ğŸ”µ *REQ-006ã‚ˆã‚Š*

- playerIdã‚’UUIDã§ç”Ÿæˆã—ã€æ¨æ¸¬ä¸å¯èƒ½ã«ã™ã‚‹
- å†æ¥ç¶šæ™‚ã«playerIdã¨socketIdã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ¤œè¨¼

### 3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ ğŸŸ¡ *architecture.mdæ—¢å­˜è¨­è¨ˆã‚ˆã‚Š*

```typescript
// é€£ç¶šã‚¢ã‚¯ã‚·ãƒ§ãƒ³é˜²æ­¢
const MIN_ACTION_INTERVAL = 100; // 100ms

function checkRateLimit(playerId: string): boolean {
  const lastAction = actionTimestamps.get(playerId) || 0;
  const now = Date.now();

  if (now - lastAction < MIN_ACTION_INTERVAL) {
    return false;
  }

  actionTimestamps.set(playerId, now);
  return true;
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­è¨ˆ

### ç›®æ¨™ ğŸ”µ *NFR-001, NFR-002ã‚ˆã‚Š*

- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‹ã‚‰çµæœåæ˜ ã¾ã§: **1ç§’ä»¥å†…**
- ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°é–“éš”: **1ç§’é–“éš”** ã§æ­£ç¢ºã«æ›´æ–°
- åŒæ™‚æ¥ç¶šæ•°: **10ãƒ«ãƒ¼ãƒ ï¼ˆæœ€å¤§60ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰** ã‚’åŒæ™‚å‡¦ç†

### æœ€é©åŒ–æˆ¦ç•¥

1. **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•**: ãƒãƒ¼ãƒªãƒ³ã‚°ä¸è¦ã€Socket.ioã®pushé€šçŸ¥
2. **åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ **: Mapã«ã‚ˆã‚‹O(1)æ¤œç´¢
3. **éåŒæœŸå‡¦ç†**: async/awaitã§ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã‚’å›é¿

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥

### ã‚¨ãƒ©ãƒ¼åˆ†é¡ ğŸ”µ *REQ-012, REQ-013ã‚ˆã‚Š*

```typescript
interface ErrorResponse {
  message: string;      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ—¥æœ¬èªï¼‰
  code: string;         // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
  details?: object;     // è©³ç´°æƒ…å ±ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
}

enum ErrorCode {
  NOT_YOUR_TURN = 'NOT_YOUR_TURN',
  INVALID_ACTION = 'INVALID_ACTION',
  INVALID_BET_AMOUNT = 'INVALID_BET_AMOUNT',
  ROOM_NOT_FOUND = 'ROOM_NOT_FOUND',
  RECONNECT_FAILED = 'RECONNECT_FAILED',
  TIMEOUT = 'TIMEOUT',
  INTERNAL_ERROR = 'INTERNAL_ERROR'
}
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ğŸ”µ *REQ-029, REQ-030ã‚ˆã‚Š*

- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã§ä¸€æ™‚çš„ã«è¡¨ç¤º
- åˆ†ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- è‡ªå‹•ã§æ¶ˆãˆã‚‹ï¼ˆ3ç§’ç¨‹åº¦ï¼‰

---

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚®ãƒ³ã‚°è¨­è¨ˆ

### ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«å®šç¾© ğŸ”µ *REQ-015ã‚ˆã‚Š*

- **ERROR**: ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã€ä¾‹å¤–ã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
- **WARN**: ç•°å¸¸ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- **INFO**: ã‚²ãƒ¼ãƒ é–‹å§‹/çµ‚äº†ã€é‡è¦ã‚¤ãƒ™ãƒ³ãƒˆ
- **DEBUG**: è©³ç´°ãªã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ã€å†…éƒ¨çŠ¶æ…‹ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰

### ãƒ­ã‚°å‡ºåŠ›ä¾‹ ğŸ”µ *REQ-119~123ã‚ˆã‚Š*

```json
{
  "timestamp": "2025-11-22T10:30:00.123Z",
  "level": "info",
  "message": "Game started",
  "roomId": "abc123",
  "players": ["player1", "player2"],
  "smallBlind": 10,
  "bigBlind": 20
}

{
  "timestamp": "2025-11-22T10:30:05.456Z",
  "level": "debug",
  "message": "Player action",
  "playerId": "player1",
  "action": "bet",
  "amount": 50,
  "remainingChips": 950
}

{
  "timestamp": "2025-11-22T10:30:10.789Z",
  "level": "error",
  "message": "Validation error",
  "errorCode": "INVALID_BET_AMOUNT",
  "playerId": "player1",
  "stack": "..."
}
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­è¨ˆ

### é–‹ç™ºç’°å¢ƒ ğŸ”µ *tech-stack.md, requirements.mdã‚ˆã‚Š*

```
Frontend: localhost:5173 (Vite dev server)
Backend:  localhost:3000 (Node.js + nodemon)
```

### æœ¬ç•ªç’°å¢ƒï¼ˆå°†æ¥ï¼‰ğŸŸ¡ *tech-stack.mdã€Œãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³Cã€ã‚ˆã‚Š*

```
Frontend: Vercel (CDNé…ä¿¡)
Backend:  Render / Fly.io (WebSocketå¯¾å¿œ)
```

**æ³¨**: ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³Bã§ã¯æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã¯æƒ³å®šã›ãšã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ»é–‹ç™ºç’°å¢ƒã®ã¿

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|---------|
| 2025-11-22 | 1.0 | åˆç‰ˆä½œæˆï¼ˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³BæŠ€è¡“è¨­è¨ˆï¼‰ |
