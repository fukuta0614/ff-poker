# FF Poker - 要件定義書 (v2.0)

**作成日**: 2025-12-02
**バージョン**: 2.0
**ステータス**: Draft

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
**FF Poker** - Fast & Fair Poker

### 1.2 目的
リアルタイムマルチプレイヤーテキサスホールデムポーカーゲームの実装。
Web技術を用いて、複数プレイヤーが同時に参加可能な公平で高速なポーカーゲーム体験を提供する。

### 1.3 ターゲットユーザー
- ポーカーを楽しみたい一般ユーザー
- 友人グループでのオンライン対戦
- ポーカー学習者

### 1.4 技術スタック
- **フロントエンド**: React 18 + TypeScript + Vite
- **バックエンド**: Node.js 20 + Express + Socket.io
- **テストフレームワーク**: Jest (server), Vitest (client), Playwright (E2E)
- **スタイリング**: Tailwind CSS
- **デプロイ**: Netlify (client), Render (server)

---

## 2. 機能要件

### 2.1 ゲーム基本機能

#### FR-001: ルーム作成
**優先度**: 高
**EARS形式**:
- ユーザーがルームを作成する場合、システムはスモールブラインド、ビッグブラインドを指定させる
- システムは一意のルームIDを生成する
- ユーザーはホストプレイヤーとして自動的にルームに参加する
- 初期チップ数は1000で固定とする

**受け入れ基準**:
- [x] ルームID生成アルゴリズムの実装(8文字のランダム英数字)
- [x] スモールブラインド: 1-10000の範囲で設定可能
- [x] ビッグブラインド: スモールブラインドの2倍
- [x] ルーム作成後、即座に参加可能な状態になる

#### FR-002: ルーム参加
**優先度**: 高
**EARS形式**:
- ユーザーがルームIDを指定してルームに参加する場合、システムはプレイヤー名を要求する
- システムは最大6人までの参加を許可する
- 7人目以降の参加はエラーとして拒否される

**受け入れ基準**:
- [x] ルームIDによる検索機能
- [x] プレイヤー名の入力(1-20文字)
- [x] 最大プレイヤー数のバリデーション
- [x] 参加後、他のプレイヤーにbroadcast通知

#### FR-003: ゲーム開始
**優先度**: 高
**EARS形式**:
- ホストプレイヤーがゲーム開始を要求する場合、システムは2人以上のプレイヤーがいることを確認する
- システムはディーラーボタンをランダムに割り当てる
- 自動的にブラインドを徴収し、ラウンドを開始する

**受け入れ基準**:
- [x] 最小プレイヤー数: 2人
- [x] ディーラーボタンの初期位置はランダム
- [x] スモールブラインド・ビッグブラインド自動徴収
- [x] 全プレイヤーに手札を2枚配布

#### FR-004: プレイヤーアクション
**優先度**: 高
**EARS形式**:
- 自分のターンの場合、プレイヤーは以下のアクションを選択できる:
  - **Fold**: 降りる
  - **Check**: チェック(ベット額が揃っている場合のみ)
  - **Call**: コール(現在のベット額に合わせる)
  - **Bet**: ベット(新たにベット)
  - **Raise**: レイズ(既存ベットを上乗せ)
  - **All-in**: オールイン(全チップをベット)

**受け入れ基準**:
- [x] ターン制御: 自分のターンのみアクション可能
- [x] バリデーション: 無効なアクションは拒否
- [x] ベット額の検証: 最小レイズ額、チップ残高
- [x] アクション後に次プレイヤーへターン移行

#### FR-005: ベッティングラウンド
**優先度**: 高
**EARS形式**:
- ベッティングラウンドが完了した場合、システムは次のストリートへ進む
- システムは以下の順序でゲームを進行する:
  1. **Preflop**: 手札2枚配布、ブラインド徴収
  2. **Flop**: コミュニティカード3枚公開
  3. **Turn**: コミュニティカード1枚追加
  4. **River**: コミュニティカード1枚追加
  5. **Showdown**: 役判定・勝者決定

**受け入れ基準**:
- [x] 各ストリートでのベッティング完了判定
- [x] コミュニティカードの段階的公開
- [x] プリフロップではBBが最後にアクション権を持つ
- [x] 1人を除いて全員フォールドした場合、即座にラウンド終了

#### FR-006: 役判定とポット分配
**優先度**: 高
**EARS形式**:
- ショーダウン時、システムは各プレイヤーの役を判定する
- システムは最も強い役を持つプレイヤーにポットを分配する
- 複数プレイヤーがオールインしている場合、サイドポットを計算する

**受け入れ基準**:
- [x] ポーカー役の正確な判定(pokersolver利用)
- [x] サイドポット計算アルゴリズムの実装
- [x] 同率の場合の分配(チップを均等分配)
- [x] 勝者へのチップ付与

#### FR-007: ラウンド継続
**優先度**: 高
**EARS形式**:
- ラウンド終了後、システムはディーラーボタンを時計回りに移動する
- チップが0になったプレイヤーは除外される
- 2人以上のプレイヤーが残っている場合、自動的に次ラウンドを開始する

**受け入れ基準**:
- [x] ディーラーボタンのローテーション
- [x] 破産プレイヤーの除外
- [x] 1人のみ残った場合、ゲーム終了
- [x] 次ラウンドの自動開始

### 2.2 通信機能

#### FR-101: クライアント-サーバー通信(WebSocket)
**優先度**: 高
**EARS形式**:
- クライアントがアクションを送信する場合、システムは `{ success: boolean, error?: string }` 形式でレスポンスを返す
- サーバーはゲーム状態の更新を `stateUpdated` イベントで全クライアントにブロードキャストする
- 手札配布は個別送信で実施する

**受け入れ基準**:
- [x] Action → Response のシンプルなIF
- [x] `stateUpdated` イベントによる状態同期
- [x] 手札情報の個別送信(セキュリティ)
- [x] エラーハンドリング

#### FR-102: 楽観的更新(Optimistic Update)
**優先度**: 中
**EARS形式**:
- プレイヤーがアクションを実行した場合、クライアントは即座にUIを更新する
- サーバーからの `stateUpdated` で最終的な状態に同期する
- アクションが拒否された場合、元の状態にロールバックする

**受け入れ基準**:
- [x] アクション送信時の即座のUI反映
- [x] サーバー応答による状態補正
- [x] エラー時のロールバック処理

### 2.3 セキュリティ要件

#### FR-201: 入力バリデーション
**優先度**: 高
**EARS形式**:
- ユーザーが入力を送信する場合、システムはクライアント側とサーバー側の両方で検証する
- XSS攻撃を防ぐため、HTMLタグを除去する
- 不正なアクション(自分のターンでない、チップ不足等)は拒否する

**受け入れ基準**:
- [x] プレイヤー名: 1-20文字、HTMLタグ除去
- [x] ルームID: 8文字の英数字のみ
- [x] ベット額: 正の整数、チップ残高以下
- [x] ターン検証: 必ずサーバー側で実施

#### FR-202: カード情報の保護
**優先度**: 高
**EARS形式**:
- 手札配布時、システムは各プレイヤーに個別に手札を送信する
- 他のプレイヤーの手札情報はクライアントに送信しない
- ショーダウン時のみ、全プレイヤーの手札を公開する

**受け入れ基準**:
- [x] `dealHand` イベントは個別送信(Socket.io の `socket.emit()`)
- [x] ゲーム状態に手札情報を含めない
- [x] ショーダウン時のみカード公開

### 2.4 再接続・タイムアウト機能

#### FR-301: 再接続機能
**優先度**: 中
**EARS形式**:
- プレイヤーが切断された場合、システムは120秒間セッションを保持する
- プレイヤーが120秒以内に再接続した場合、ゲームに復帰できる
- 120秒超過した場合、自動的にフォールドする

**受け入れ基準**:
- [x] セッション管理(SessionManager)
- [x] グレースピリオド: 120秒
- [x] 再接続時にゲーム状態・手札を送信
- [x] タイムアウト後の自動フォールド

#### FR-302: ターンタイムアウト
**優先度**: 中
**EARS形式**:
- 自分のターンの場合、プレイヤーは60秒以内にアクションを実行しなければならない
- 残り10秒で警告を表示する
- 60秒経過した場合、自動的にフォールドする

**受け入れ基準**:
- [x] ターンタイマー: 60秒
- [x] 警告閾値: 10秒
- [x] タイマー更新イベント(1秒毎)
- [x] タイムアウト時の自動フォールド

### 2.5 ロギング・監視

#### FR-401: ロギング
**優先度**: 中
**EARS形式**:
- システムは重要なイベント(ルーム作成、ゲーム開始、アクション等)をログに記録する
- ログレベルは debug, info, warn, error の4種類とする
- ログはファイルとコンソールに出力する

**受け入れ基準**:
- [x] winston統合
- [x] ログファイル: `logs/combined.log`, `logs/error.log`
- [x] 開発時のコンソール出力
- [x] 構造化ログ(JSON形式)

---

## 3. 非機能要件

### 3.1 パフォーマンス

#### NFR-001: レスポンスタイム
- アクション実行から `stateUpdated` 送信まで: 100ms以内
- ゲーム開始からカード配布まで: 200ms以内

#### NFR-002: 同時接続数
- 単一サーバーで最大100ルーム(600プレイヤー)の同時接続をサポート

### 3.2 可用性

#### NFR-101: 稼働率
- 稼働率 95% 以上(開発段階では目標値)

#### NFR-102: 再接続成功率
- グレースピリオド内の再接続成功率: 90% 以上

### 3.3 保守性

#### NFR-201: テストカバレッジ
- **Server**: 80% 以上(unit + integration)
- **Client**: 70% 以上(unit + integration)
- **E2E**: 主要シナリオ(ゲーム開始→ラウンド終了)を網羅

#### NFR-202: コード品質
- TypeScript strict mode 有効
- ESLint/Prettier による自動フォーマット
- `any` 型の使用禁止(やむを得ない場合は `unknown`)

### 3.4 スケーラビリティ

#### NFR-301: 水平スケール
- 将来的に Redis を用いたマルチサーバー構成に移行可能な設計

---

## 4. システム制約

### 4.1 技術制約
- Node.js 20.x LTS
- ブラウザ: Chrome, Firefox, Safari 最新版
- モバイルブラウザは非対応(将来的に検討)

### 4.2 データ制約
- ルーム数: 無制限(メモリ許容範囲)
- プレイヤー数: 最大6人/ルーム
- ゲーム履歴: 保存しない(将来的に検討)

### 4.3 セキュリティ制約
- HTTPS必須(本番環境)
- CORS設定: 本番ドメインのみ許可
- 環境変数による機密情報管理

---

## 5. ユーザーストーリー

### US-001: 友人とのポーカーゲーム
**As a** ポーカー愛好家
**I want to** 友人とオンラインでポーカーをプレイしたい
**So that** 物理的に集まらなくてもゲームを楽しめる

**受け入れ基準**:
- ルームを作成し、友人にルームIDを共有できる
- 友人がルームIDで参加できる
- ゲームが正常に進行し、勝者が決定される

### US-002: スムーズなゲーム体験
**As a** プレイヤー
**I want to** アクションが即座に反映されるUIを体験したい
**So that** ストレスなくゲームに集中できる

**受け入れ基準**:
- アクション実行後、即座にUIが更新される
- サーバー応答が遅延しても、楽観的更新により体感速度が向上する
- エラー時は適切にロールバックされる

### US-003: 公平なゲーム運営
**As a** プレイヤー
**I want to** 他のプレイヤーの手札が見えないことを保証したい
**So that** 公平なゲームができる

**受け入れ基準**:
- 手札は個別送信され、他プレイヤーに漏洩しない
- デバッグツールでも他プレイヤーの手札は確認できない
- ショーダウン時のみカードが公開される

---

## 6. 開発フェーズ

### Phase 1: コア実装(優先度: 高)
- game_engine モジュールの実装
- Room管理モジュールの実装
- WebSocket通信層の実装
- 基本UI(ルーム作成、参加、ゲーム画面)
- Unit/Integrationテスト

### Phase 2: UX改善(優先度: 中)
- 楽観的更新の実装
- 再接続機能
- ターンタイムアウト
- エラーハンドリング強化

### Phase 3: 本番対応(優先度: 中)
- Redis統合(マルチサーバー)
- ロギング・監視
- デプロイ設定(Netlify/Render)
- E2Eテスト

### Phase 4: 将来拡張(優先度: 低)
- ゲーム履歴保存(PostgreSQL)
- 統計情報表示
- アニメーション(framer-motion)
- モバイル対応

---

## 7. 成功基準

### 7.1 機能面
- [x] 2-6人でのゲームが正常に動作する
- [x] テキサスホールデムのルールが正確に実装されている
- [x] 役判定とポット分配が正しい

### 7.2 技術面
- [x] テストカバレッジが基準を満たしている
- [x] game_engineがstatelessで実装されている
- [x] Client-Server IFがシンプルで保守しやすい

### 7.3 UX面
- [x] アクションのレスポンスが高速(楽観的更新)
- [x] エラーメッセージが分かりやすい
- [x] 再接続がスムーズ

---

## 8. リスクと対策

### リスク1: game_engineの設計ミス
**影響度**: 高
**対策**: TDD徹底、unit testで早期発見

### リスク2: WebSocket接続の不安定性
**影響度**: 中
**対策**: 再接続機能、タイムアウト処理

### リスク3: スケーラビリティ不足
**影響度**: 低(初期)
**対策**: Redis統合を視野に入れた設計

---

## 9. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|----------|------|---------|--------|
| 1.0 | 2024-11-19 | 初版作成 | - |
| 2.0 | 2025-12-02 | 大規模設計変更に伴う全面改訂 | - |

---

## 10. 承認

| 役割 | 氏名 | 承認日 | 署名 |
|-----|------|--------|------|
| プロダクトオーナー | - | - | - |
| 技術リード | - | - | - |
| QAリード | - | - | - |

---

**Document End**
